From 4afa072e1b377ca3f7f2ac4b6f0b5a66d7ef5855 Mon Sep 17 00:00:00 2001
Message-ID: <4afa072e1b377ca3f7f2ac4b6f0b5a66d7ef5855.1738312015.git.lorenzo@kernel.org>
In-Reply-To: <b0dc2764916f8b57f50b2252061e039b6bacb10d.1738312015.git.lorenzo@kernel.org>
References: <b0dc2764916f8b57f50b2252061e039b6bacb10d.1738312015.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Tue, 28 Jan 2025 09:24:25 +0100
Subject: [PATCH net-next 8/9] netfilter: nft_flow_offload: Add flow mark to
 flowtable offload

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 include/net/netfilter/nf_flow_table.h |  1 +
 net/netfilter/nf_flow_table_offload.c |  8 ++++++++
 net/netfilter/nft_flow_offload.c      | 11 +++++++++++
 3 files changed, 20 insertions(+)

--- a/include/net/netfilter/nf_flow_table.h
+++ b/include/net/netfilter/nf_flow_table.h
@@ -137,6 +137,7 @@ struct flow_offload_tuple {
 					encap_num:2,
 					in_vlan_ingress:2;
 	u16				mtu;
+	u32				priority;
 	union {
 		struct {
 			struct dst_entry *dst_cache;
--- a/net/netfilter/nf_flow_table_offload.c
+++ b/net/netfilter/nf_flow_table_offload.c
@@ -653,6 +653,14 @@ nf_flow_rule_route_common(struct net *ne
 		}
 	}
 
+	if (tuple->priority) {
+		struct flow_action_entry *entry;
+
+		entry = flow_action_entry_next(flow_rule);
+		entry->id = FLOW_ACTION_PRIORITY;
+		entry->priority = tuple->priority;
+	}
+
 	other_tuple = &flow->tuplehash[!dir].tuple;
 
 	for (i = 0; i < other_tuple->encap_num; i++) {
--- a/net/netfilter/nft_flow_offload.c
+++ b/net/netfilter/nft_flow_offload.c
@@ -271,6 +271,16 @@ static int nft_flow_route(const struct n
 	return 0;
 }
 
+static void nft_flow_set_priority(const struct nft_pktinfo *pkt,
+				  struct flow_offload *flow,
+				  enum ip_conntrack_dir dir)
+{
+	struct flow_offload_tuple *tuple;
+
+	tuple = &flow->tuplehash[dir].tuple;
+	tuple->priority = pkt->skb->priority;
+}
+
 static bool nft_flow_offload_skip(struct sk_buff *skb, int family)
 {
 	if (skb_sec_path(skb))
@@ -363,6 +373,7 @@ static void nft_flow_offload_eval(const
 	if (!flow)
 		goto err_flow_alloc;
 
+	nft_flow_set_priority(pkt, flow, dir);
 	flow_offload_route_init(flow, &route);
 	if (tcph)
 		flow_offload_ct_tcp(ct);
