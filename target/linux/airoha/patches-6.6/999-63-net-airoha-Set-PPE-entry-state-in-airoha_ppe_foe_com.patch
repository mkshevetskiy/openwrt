From eeaed4b179cb508affa2c7c501ec48c4ee6f9c0e Mon Sep 17 00:00:00 2001
Message-ID: <eeaed4b179cb508affa2c7c501ec48c4ee6f9c0e.1749980116.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Thu, 12 Jun 2025 22:45:44 +0200
Subject: [PATCH net] net: airoha: Set PPE entry state in
 airoha_ppe_foe_commit_entry()

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 drivers/net/ethernet/airoha/airoha_eth.h |  2 +-
 drivers/net/ethernet/airoha/airoha_ppe.c | 15 ++++++++-------
 2 files changed, 9 insertions(+), 8 deletions(-)

--- a/drivers/net/ethernet/airoha/airoha_eth.h
+++ b/drivers/net/ethernet/airoha/airoha_eth.h
@@ -240,7 +240,7 @@ struct airoha_hw_stats {
 	u64 rx_len[7];
 };
 
-enum {
+enum airoha_foe_state {
 	AIROHA_FOE_STATE_INVALID,
 	AIROHA_FOE_STATE_UNBIND,
 	AIROHA_FOE_STATE_BIND,
--- a/drivers/net/ethernet/airoha/airoha_ppe.c
+++ b/drivers/net/ethernet/airoha/airoha_ppe.c
@@ -615,7 +615,8 @@ static bool airoha_ppe_foe_compare_entry
 
 static int airoha_ppe_foe_commit_entry(struct airoha_ppe *ppe,
 				       struct airoha_foe_entry *e,
-				       u32 hash, bool rx_wlan)
+				       u32 hash, bool rx_wlan,
+				       enum airoha_foe_state state)
 {
 	struct airoha_foe_entry *hwe = ppe->foe + hash * sizeof(*hwe);
 	u32 ts = airoha_ppe_get_timestamp(ppe);
@@ -629,6 +630,8 @@ static int airoha_ppe_foe_commit_entry(s
 	e->ib1 &= ~AIROHA_FOE_IB1_BIND_TIMESTAMP;
 	e->ib1 |= FIELD_PREP(AIROHA_FOE_IB1_BIND_TIMESTAMP, ts);
 	hwe->ib1 = e->ib1;
+	hwe->ib1 &= ~AIROHA_FOE_IB1_BIND_STATE;
+	hwe->ib1 |= FIELD_PREP(AIROHA_FOE_IB1_BIND_STATE, state);
 
 	rcu_read_lock();
 
@@ -662,10 +665,8 @@ static void airoha_ppe_foe_remove_flow(s
 
 	hlist_del_init(&e->list);
 	if (e->hash != 0xffff) {
-		e->data.ib1 &= ~AIROHA_FOE_IB1_BIND_STATE;
-		e->data.ib1 |= FIELD_PREP(AIROHA_FOE_IB1_BIND_STATE,
-					  AIROHA_FOE_STATE_INVALID);
-		airoha_ppe_foe_commit_entry(ppe, &e->data, e->hash, false);
+		airoha_ppe_foe_commit_entry(ppe, &e->data, e->hash, false,
+					    AIROHA_FOE_STATE_INVALID);
 		e->hash = 0xffff;
 	}
 	if (e->type == FLOW_TYPE_L2_SUBFLOW) {
@@ -743,7 +744,8 @@ airoha_ppe_foe_commit_subflow_entry(stru
 	}
 
 	hwe.bridge.data = e->data.bridge.data;
-	airoha_ppe_foe_commit_entry(ppe, &hwe, hash, rx_wlan);
+	airoha_ppe_foe_commit_entry(ppe, &hwe, hash, rx_wlan,
+				    AIROHA_FOE_STATE_BIND);
 
 	return 0;
 }
@@ -785,7 +787,8 @@ static void airoha_ppe_foe_insert_entry(
 			continue;
 		}
 
-		airoha_ppe_foe_commit_entry(ppe, &e->data, hash, rx_wlan);
+		airoha_ppe_foe_commit_entry(ppe, &e->data, hash, rx_wlan,
+					    AIROHA_FOE_STATE_BIND);
 		commit_done = true;
 		e->hash = hash;
 	}
