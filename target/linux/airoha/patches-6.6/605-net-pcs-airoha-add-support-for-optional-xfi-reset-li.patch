From 813f97815b632dae7e1d5e7328df2fa6202ef8d5 Mon Sep 17 00:00:00 2001
From: Christian Marangi <ansuelsmth@gmail.com>
Date: Sat, 26 Jul 2025 22:58:10 +0200
Subject: [PATCH 5/6] net: pcs: airoha: add support for optional xfi reset line

On Airoha AN7583 there is a dedicated reset line for the PON XFI Serdes.
This is needed to permit changing the WAN sel register or the system
will stall on accessing the XFI register.

Add support for this optional dedicated reset to permit correct
configuration of the PON Serdes.

Signed-off-by: Christian Marangi <ansuelsmth@gmail.com>
---
 drivers/net/pcs/pcs-airoha.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/drivers/net/pcs/pcs-airoha.c b/drivers/net/pcs/pcs-airoha.c
index 954cb472051d..1849fc9b91a1 100644
--- a/drivers/net/pcs/pcs-airoha.c
+++ b/drivers/net/pcs/pcs-airoha.c
@@ -1177,6 +1177,7 @@ struct airoha_pcs_priv {
 	struct regmap *xfi_pma;
 	struct regmap *xfi_ana;
 
+	struct reset_control *xfi_rst;
 	struct reset_control_bulk_data rsts[AIROHA_PCS_MAX_NUM_RSTS];
 };
 
@@ -1267,6 +1268,10 @@ static int airoha_pcs_setup_scu(struct airoha_pcs_priv *priv,
 {
 	int ret;
 
+	ret = reset_control_assert(priv->xfi_rst);
+	if (ret)
+		return ret;
+
 	switch (priv->data->port_type) {
 	case AIROHA_PCS_ETH:
 		airoha_pcs_setup_scu_eth(priv, interface);
@@ -1276,6 +1281,10 @@ static int airoha_pcs_setup_scu(struct airoha_pcs_priv *priv,
 		break;
 	}
 
+	ret = reset_control_deassert(priv->xfi_rst);
+	if (ret)
+		return ret;
+
 	/* TODO better handle reset from MAC */
 	ret = reset_control_bulk_assert(ARRAY_SIZE(priv->rsts),
 					priv->rsts);
@@ -5687,6 +5696,10 @@ static int airoha_pcs_probe(struct platform_device *pdev)
 	if (ret)
 		return dev_err_probe(dev, ret, "failed to get bulk reset lines\n");
 
+	priv->xfi_rst = devm_reset_control_get_optional_exclusive(dev, "xfi");
+	if (IS_ERR(priv->xfi_rst))
+		return dev_err_probe(dev, PTR_ERR(priv->xfi_rst), "failed to get xfi reset lines\n");
+
 	platform_set_drvdata(pdev, priv);
 
 	return 0;
-- 
2.50.0

